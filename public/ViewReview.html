<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>리뷰 목록 페이지</title>
    <link rel="stylesheet" type="text/css" href="menubar.css">
    <!--메뉴바 폰트-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">    <title>웹페이지 이름 미정</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        .review-table th, .review-table td {
            text-align: center;
            vertical-align: middle;
        }
        .new-badge {
            color: red;
            font-weight: bold;
        }
        .profile-picture {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
        }
        .delete-btn {
            color: red;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <nav class="menubar">
        <div class="menubar__logo">
            <i class="fa-solid fa-person-walking-luggage"></i>
            <a href="main.html">사이트이름</a>
        </div>
        <div class="menubar__menu">
            <li><a href="">여행지</a></li>
            <li><a href="">길찾기</a></li>
            <li><a href="">리뷰</a></li>
            <li><a href="">행사</a></li>
        </div>
        <!-- 로그인 페이지로 이동 -->
        <a href="" class="menubar__login">
            <i class="fa-solid fa-user"></i>
        <a href="#" class="menubar__toggleBtn">
            <i class="fa-solid fa-bars"></i>
        </a>
    </nav>
    <div class="container">
        <h1 class="text-center">리뷰 목록</h1>
        <table class="table table-striped review-table">
            <thead>
                <tr>
                    <th scope="col">번호</th>
                    <th scope="col">제목</th>
                    <th scope="col">글쓴이</th>
                    <th scope="col">날짜</th>
                    <th scope="col">조회 수</th>
                    <th scope="col">삭제</th>
                </tr>
            </thead>
            <tbody id="reviewsContainer">
                <!-- 리뷰 목록이 여기에 삽입됩니다. -->
            </tbody>
        </table>
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- 페이지네이션 버튼이 여기에 삽입됩니다. -->
            </ul>
        </nav>
    </div>

    <!-- 모달 창 -->
    <div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="reviewModalLabel">리뷰 세부 내용</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="reviewDetailBody">
            <!-- 세부 내용이 여기에 표시됩니다. -->
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, query, getDocs, orderBy, limit, startAfter, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQI-YZlvaxuAs0ZXWY4YXrJsqAzlGBEa0",
            authDomain: "loginweb-4a1a6.firebaseapp.com",
            projectId: "loginweb-4a1a6",
            storageBucket: "loginweb-4a1a6.appspot.com",
            messagingSenderId: "47986024855",
            appId: "1:47986024855:web:6f5d2c1c6457269871e4d2",
            measurementId: "G-2159KP57E5"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth();
        const db = getFirestore(app);

        let lastVisibleReview = null;
        const reviewsContainer = document.getElementById('reviewsContainer');
        const pagination = document.getElementById('pagination');
        const pageSize = 10; // 한 페이지에 보여줄 리뷰 수

        const loadReviews = async (pageSize = 10) => {
            reviewsContainer.innerHTML = '';
            pagination.innerHTML = '';

            const reviewsQuery = query(
                collection(db, 'reviews'),
                orderBy('timestamp', 'desc'),
                limit(pageSize)
            );

            const querySnapshot = await getDocs(reviewsQuery);
            querySnapshot.forEach((doc, index) => {
                const review = doc.data();
                const reviewDate = new Date(review.timestamp.seconds * 1000);
                const now = new Date();
                const timeDiff = Math.abs(now - reviewDate);
                const isNew = timeDiff / (1000 * 3600) < 24; // 24시간 이내의 리뷰는 NEW 배지 표시

                reviewsContainer.innerHTML += `
                    <tr>
                        <th scope="row">${index + 1}</th>
                        <td><a href="#" onclick="showReviewDetails('${doc.id}')">${review.title}</a> ${isNew ? '<span class="new-badge">NEW</span>' : ''}</td>
                        <td>
                            <img src="${review.userPhoto}" class="profile-picture" alt="프로필 사진"> 
                            ${review.userName}
                        </td>
                        <td>${reviewDate.toLocaleDateString()}</td>
                        <td>${review.views || 0}</td>
                        <td>${auth.currentUser.uid === review.userId ? '<span class="delete-btn" onclick="event.stopPropagation(); deleteReview(\'' + doc.id + '\')">삭제</span>' : ''}</td>
                    </tr>
                `;
            });

            lastVisibleReview = querySnapshot.docs[querySnapshot.docs.length - 1];

            // 페이지네이션 추가
            pagination.innerHTML += `
                <li class="page-item ${!querySnapshot.docs.length ? 'disabled' : ''}">
                    <a class="page-link" href="#" aria-label="Previous" onclick="loadPreviousPage()">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#" onclick="loadNextPage()">Next</a>
                </li>
            `;
        };

        const loadNextPage = async () => {
            if (!lastVisibleReview) return;

            const reviewsQuery = query(
                collection(db, 'reviews'),
                orderBy('timestamp', 'desc'),
                startAfter(lastVisibleReview),
                limit(pageSize)
            );

            const querySnapshot = await getDocs(reviewsQuery);

            querySnapshot.forEach((doc, index) => {
                const review = doc.data();
                const reviewDate = new Date(review.timestamp.seconds * 1000);
                const now = new Date();
                const timeDiff = Math.abs(now - reviewDate);
                const isNew = timeDiff / (1000 * 3600) < 24; // 24시간 이내의 리뷰는 NEW 배지 표시

                reviewsContainer.innerHTML += `
                    <tr>
                        <th scope="row">${index + 1}</th>
                        <td><a href="#" onclick="showReviewDetails('${doc.id}')">${review.title}</a> ${isNew ? '<span class="new-badge">NEW</span>' : ''}</td>
                        <td>
                            <img src="${review.userPhoto}" class="profile-picture" alt="프로필 사진"> 
                            ${review.userName}
                        </td>
                        <td>${reviewDate.toLocaleDateString()}</td>
                        <td>${review.views || 0}</td>
                        <td>${auth.currentUser.uid === review.userId ? '<span class="delete-btn" onclick="event.stopPropagation(); deleteReview(\'' + doc.id + '\')">삭제</span>' : ''}</td>
                    </tr>
                `;
            });

            lastVisibleReview = querySnapshot.docs[querySnapshot.docs.length - 1];
        };

        const loadPreviousPage = async () => {
            if (!lastVisibleReview) return;

            const reviewsQuery = query(
                collection(db, 'reviews'),
                orderBy('timestamp', 'desc'),
                endBefore(firstVisibleReview),
                limitToLast(pageSize + 1)
            );

            const querySnapshot = await getDocs(reviewsQuery);

            const reviews = [];
            querySnapshot.forEach((doc) => {
                reviews.push({ id: doc.id, data: doc.data() });
            });
            // 현재 페이지의 첫 번째 리뷰를 삭제하고 업데이트합니다.
            reviews.shift();

            // 리뷰 목록을 업데이트합니다.
            reviewsContainer.innerHTML = '';
            reviews.forEach((review, index) => {
                const reviewData = review.data;
                const reviewDate = new Date(reviewData.timestamp.seconds * 1000);
                const now = new Date();
                const timeDiff = Math.abs(now - reviewDate);
                const isNew = timeDiff / (1000 * 3600) < 24; // 24시간 이내의 리뷰는 NEW 배지 표시

                reviewsContainer.innerHTML += `
                    <tr>
                        <th scope="row">${index + 1}</th>
                        <td><a href="#" onclick="showReviewDetails('${review.id}')">${reviewData.title}</a> ${isNew ? '<span class="new-badge">NEW</span>' : ''}</td>
                        <td>
                            <img src="${reviewData.userPhoto}" class="profile-picture" alt="프로필 사진"> 
                            ${reviewData.userName}
                        </td>
                        <td>${reviewDate.toLocaleDateString()}</td>
                        <td>${reviewData.views || 0}</td>
                        <td>${auth.currentUser.uid === reviewData.userId ? '<span class="delete-btn" onclick="event.stopPropagation(); deleteReview(\'' + review.id + '\')">삭제</span>' : ''}</td>
                    </tr>
                `;
            });

            lastVisibleReview = querySnapshot.docs[querySnapshot.docs.length - 1];
        };

        const showReviewDetails = async (reviewId) => {
            const reviewDoc = await getDoc(doc(db, 'reviews', reviewId));
            const review = reviewDoc.data();

            if (review) {
                window.location.href = `review_detail.html?reviewId=${reviewId}`;
            } else {
                alert('리뷰를 불러오는 데 실패했습니다.');
            }
        };

        window.deleteReview = async (reviewId) => {
            if (!confirm('리뷰를 삭제하시겠습니까?')) return;

            try {
                await deleteDoc(doc(db, 'reviews', reviewId));
                loadReviews(pageSize);
            } catch (error) {
                console.error('리뷰 삭제 실패:', error);
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loadReviews(pageSize);
            } else {
                alert('로그인이 필요합니다.');
                window.location.href = 'login.html';
            }
        });
    </script>
</body>
</html>

