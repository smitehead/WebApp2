<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>리뷰 작성</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5nlyT2bRjXhW+ALEwIH" crossorigin="anonymous">
    <style>
        .review-form-container {
            max-width: 600px;
            margin: auto;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .profile-picture {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
        }
        .username {
            font-weight: bold;
        }
        .form-group {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center">리뷰 작성</h1>
        <div class="review-form-container">
            <div class="d-flex align-items-center mb-4">
                <img src="" id="userPhoto" class="profile-picture" alt="프로필 사진">
                <span id="userName" class="username"></span>
            </div>
            <div class="form-group">
                <label for="reviewContent">리뷰 내용</label>
                <textarea class="form-control" id="reviewContent" rows="5" placeholder="리뷰를 작성하세요..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary" id="submitReview">리뷰 등록</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyDQI-YZlvaxuAs0ZXWY4YXrJsqAzlGBEa0",
            authDomain: "loginweb-4a1a6.firebaseapp.com",
            projectId: "loginweb-4a1a6",
            storageBucket: "loginweb-4a1a6.appspot.com",
            messagingSenderId: "47986024855",
            appId: "1:47986024855:web:6f5d2c1c6457269871e4d2",
            measurementId: "G-2159KP57E5"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth();
        const db = getFirestore(app);

        // UI 요소 참조
        const userNameElement = document.getElementById('userName');
        const userPhotoElement = document.getElementById('userPhoto');
        const reviewContentElement = document.getElementById('reviewContent');
        const submitReviewButton = document.getElementById('submitReview');

        // 인증 상태 변경 감지
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userNameElement.textContent = user.displayName || '익명 사용자';
                userPhotoElement.src = user.photoURL || 'default-profile.png';

                // 리뷰 제출 버튼 클릭 이벤트
                submitReviewButton.addEventListener('click', async () => {
                    const content = reviewContentElement.value.trim();
                    if (content === '') {
                        alert('리뷰 내용을 입력하세요.');
                        return;
                    }

                    try {
                        // Firestore에 새로운 리뷰 추가
                        await addDoc(collection(db, 'reviews'), {
                            userId: user.uid,
                            userName: user.displayName || '익명 사용자',
                            userPhoto: user.photoURL || 'default-profile.png',
                            content: content,
                            timestamp: serverTimestamp(),
                            recommendations: 0 // 기본 추천 수 설정
                        });

                        alert('리뷰가 등록되었습니다.');
                        window.location.href = 'reviews.html'; // 리뷰 목록 페이지로 리디렉션
                    } catch (error) {
                        console.error('리뷰 등록 중 오류 발생:', error);
                        alert('리뷰 등록 중 오류가 발생했습니다. 다시 시도해주세요.');
                    }
                });
            } else {
                alert('로그인이 필요합니다.');
                window.location.href = 'login.html';
            }
        });
    </script>
</body>
</html>
